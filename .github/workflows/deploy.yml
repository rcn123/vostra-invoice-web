name: Deploy to Hetzner K8s

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Hetzner Kubernetes
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            cd /var/www/vostra-invoice-web

            # Pull latest code
            git pull origin main

            # Build Docker images
            docker build -t vostra-landing:v1 ./landing
            docker build -t vostra-invoice-frontend:v1 ./frontend

            # Import images to k3s
            docker save vostra-landing:v1 | sudo k3s ctr images import -
            docker save vostra-invoice-frontend:v1 | sudo k3s ctr images import -

            # Apply Kubernetes manifests (in case they changed)
            kubectl apply -f k8s/namespace.yaml
            kubectl apply -f k8s/landing-deployment.yaml
            kubectl apply -f k8s/landing-service.yaml
            kubectl apply -f k8s/invoice-deployment.yaml
            kubectl apply -f k8s/invoice-service.yaml
            kubectl apply -f k8s/ingress.yaml

            # Restart deployments to use new images
            kubectl rollout restart deployment/vostra-landing -n vostra
            kubectl rollout restart deployment/vostra-invoice -n vostra

            # Wait for rollout to complete
            kubectl rollout status deployment/vostra-landing -n vostra --timeout=120s
            kubectl rollout status deployment/vostra-invoice -n vostra --timeout=120s

            # Clean up old images
            docker image prune -f

            # Show final status
            echo "=== Deployment Status ==="
            kubectl get pods -n vostra
