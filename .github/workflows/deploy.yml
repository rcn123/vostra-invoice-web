name: Deploy to Hetzner K8s

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Hetzner Kubernetes
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          envs: DB_PASSWORD,OPENAI_API_KEY
          script: |
            cd /var/www/vostra-invoice-web

            # Pull latest code
            git pull origin main

            # Create namespace first
            kubectl apply -f k8s/namespace.yaml

            # Create/Update Kubernetes secrets from template (declarative, production-grade)
            # URL-encode the database password to handle special characters
            export DB_PASSWORD_ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${DB_PASSWORD}', safe=''))")
            export DATABASE_URL="postgresql://vostra:${DB_PASSWORD_ENCODED}@postgres:5432/vostra-invoice-web"
            export AI2_DATABASE_URL="postgresql://vostra:${DB_PASSWORD_ENCODED}@postgres-ai2:5432/ai2"

            # Base64 encode secrets to avoid YAML escaping issues
            export DB_PASSWORD_B64=$(echo -n "${DB_PASSWORD}" | base64 -w 0)
            export OPENAI_API_KEY_B64=$(echo -n "${OPENAI_API_KEY}" | base64 -w 0)
            export DATABASE_URL_B64=$(echo -n "${DATABASE_URL}" | base64 -w 0)
            export AI2_DATABASE_URL_B64=$(echo -n "${AI2_DATABASE_URL}" | base64 -w 0)

            echo "Creating backend secrets..."
            if [ ! -f k8s/backend-secrets.yaml.tpl ]; then
              echo "ERROR: Template file k8s/backend-secrets.yaml.tpl not found!"
              exit 1
            fi

            sed \
              -e "s|\${DB_PASSWORD_B64}|${DB_PASSWORD_B64}|g" \
              -e "s|\${OPENAI_API_KEY_B64}|${OPENAI_API_KEY_B64}|g" \
              -e "s|\${DATABASE_URL_B64}|${DATABASE_URL_B64}|g" \
              k8s/backend-secrets.yaml.tpl \
              | kubectl apply -f - || { echo "ERROR: Failed to create backend secrets!"; exit 1; }

            echo "Verifying secret was created..."
            kubectl get secret backend-secrets -n vostra-invoice-web || { echo "ERROR: Secret was not created!"; exit 1; }
            echo "âœ“ Backend secrets created successfully"

            # Build Docker images
            docker build -t vostra-landing:v1 ./landing
            docker build -t vostra-invoice-frontend:v1 ./frontend
            docker build -t vostra-api:v1 ./backend/api
            docker build -t vostra-ai-extractor:v1 ./backend/ai-extractor

            # Import images to k3s
            docker save vostra-landing:v1 | sudo k3s ctr images import -
            docker save vostra-invoice-frontend:v1 | sudo k3s ctr images import -
            docker save vostra-api:v1 | sudo k3s ctr images import -
            docker save vostra-ai-extractor:v1 | sudo k3s ctr images import -

            # Apply Kubernetes manifests (in case they changed)
            kubectl apply -f k8s/postgres-deployment.yaml
            kubectl apply -f k8s/postgres-service.yaml
            kubectl apply -f k8s/postgres-ai2-deployment.yaml
            kubectl apply -f k8s/postgres-ai2-service.yaml
            kubectl apply -f k8s/ai-extractor-deployment.yaml
            kubectl apply -f k8s/ai-extractor-service.yaml
            kubectl apply -f k8s/api-deployment.yaml
            kubectl apply -f k8s/api-service.yaml
            kubectl apply -f k8s/landing-deployment.yaml
            kubectl apply -f k8s/landing-service.yaml
            kubectl apply -f k8s/invoice-deployment.yaml
            kubectl apply -f k8s/invoice-service.yaml
            kubectl apply -f k8s/ingress.yaml

            # Wait for postgres to be ready before restarting other services
            kubectl rollout status deployment/postgres -n vostra-invoice-web --timeout=180s
            kubectl rollout status deployment/postgres-ai2 -n vostra-invoice-web --timeout=180s

            # Restart deployments to use new images
            kubectl rollout restart deployment/vostra-ai-extractor -n vostra-invoice-web
            kubectl rollout restart deployment/vostra-api -n vostra-invoice-web
            kubectl rollout restart deployment/vostra-landing -n vostra-invoice-web
            kubectl rollout restart deployment/vostra-invoice -n vostra-invoice-web

            # Wait for rollout to complete
            kubectl rollout status deployment/vostra-ai-extractor -n vostra-invoice-web --timeout=120s
            kubectl rollout status deployment/vostra-api -n vostra-invoice-web --timeout=120s
            kubectl rollout status deployment/vostra-landing -n vostra-invoice-web --timeout=120s
            kubectl rollout status deployment/vostra-invoice -n vostra-invoice-web --timeout=120s

            # Clean up old images
            docker image prune -f

            # Show final status
            echo "=== Deployment Status ==="
            kubectl get pods -n vostra-invoice-web
