Det delas upp i:

vostra-api (backend API)

vostra-ai-extractor

Frontend

Integrationstester

Mocking strategi

Load/stress testing (krävs inte nu, men bra att ha med i planen)

Du vill inte lägga tre veckor på detta — men du behöver ett minimum som gör att du vågar deploya.

1. Tester för vostra-api

Det här är den kritiska delen. API:et måste hålla.

a) File upload test (FastAPI TestClient)

Ladda upp en fake invoice (PDF eller dummy-bytar).

Kontrollera:

HTTP 201

Filen hamnar i /storage/uploads/...

En rad skapas i invoices

Status = uploaded → blir extracting → blir extracted (mockad extractor)

b) Validation tester

Fel filtyp (t.ex. .exe)

Fil > maxstorlek

Tomt request

Dubbel uppladdning (ska ge 200, inte duplicera)

c) DB-integritet

Skapa invoice → hämta invoice → jämför att raw_ai_data sparas korrekt

Approve endpoint ska:

Spara user_validated_data

Sätta approved_at

Inte skriva över raw_ai_data

d) Error flow

Simulera att AI-extractor svarar:

500

Timeout

JSON-garbage

Backend ska:

Logga

Sätta status = failed

Inte crascha

Allt detta kan testas med pytest + TestClient + en mockad HTTP-server.

2. Tester för vostra-ai-extractor

Du testar inte GPT — du testar din parser + din servicekontrakt.

a) Extract endpoint

Input med JSON {invoice_id, file_path}

Simulera filen genom att peta in en fake-PNG eller fake-PDF

Mocka GPT-svaret (en JSON-sträng)

Kontrollera:

Returnerar exakt rätt JSON

Korrekta fält namn

Felhantering när JSON saknar fält

b) PEPPOL XML parser

Liten PEPPOL-fil → validera att du får ut:

invoice_number

dates

lines

amounts

c) GPT-integration (endast 1–2 smoke tests)

Ett fåtal faktiska filer

Verifiera att du får JSON och att response inte dödar servern

3. Frontend tester

Håll det minimalt. Det viktigaste är:

a) Upload component

Mocka backend → testa att filen skickas

Testa felmeddelanden och visuella states

b) Invoice detail view

Mock API → rendera → kontrollera att alla AI-fält dyker upp

Redigera några fält → tryck "approve" → mock backend → kontrollera payload

Frontend behöver inte mycket mer än det här just nu.

4. Integrationstester (end-to-end)

Du behöver två:

Test 1: “Happy path”

Upload en fil

Mock extractor → returnera JSON

API lagrar raw_ai_data

Frontend hämtar & visar

Approve → API sparar validated_data

Test 2: “Extractor failure”

Upload fil

Extractor returnerar 500

API sätter status = “failed”

Frontend visar "Extraction failed"

Kör detta i docker-compose lokalt (inte i K8s).

5. Mocking strategi

Utan en bra mocking-strategi blir testerna ett helvete.

För API:

Mocka HTTP-anrop till ai-extractor med pytest_httpx eller respx.

För AI-extractor:

Mocka GPT-anrop med unittest.mock.patch eller pytest-mocker.

För frontend:

Mocka hela API-lagret med MSW (Mock Service Worker).

6. Pre-production tests (optional men bra)

Senare, när du ska sälja till kommuner (du kommer göra det):

Load test (5–10 filer per sekund)

Se att:

DB inte dog

Filstorage inte blev seppelinerad

API skalar med 2 pods

Security scan

Trivy på images

OWASP ZAP på API endpoints

Kort: “Den här MVP:n behöver exakt de här testerna”

Backend API

Upload

Approve

Statusflow

Error flow

JSON-integritet

AI-extractor

Input → JSON output

GPT parse

PEPPOL parse

Frontend

Upload UI

Approval UI

Integration

Happy path

Extractor fails

Mocking

respx (API)

mock GPT